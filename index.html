<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- ä¼˜åŒ– Viewportï¼šç¦æ­¢ç”¨æˆ·ç¼©æ”¾ï¼Œé€‚é…åˆ˜æµ·å± safe-area -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>IND_SHIFT_MGR_V2.1 // å·¥ä¸šç­è¡¨ç³»ç»Ÿ</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            /* è°ƒè‰²æ¿ V2 */
            --bg-paper: #E6E4D8;
            --bg-dark: #111111;
            --ink: #000000;
            --blue: #0033CC;
            --yellow: #FFCC00;
            --red: #FF3300;
            --orange: #FF6600;
            --border-thick: 3px;
        }

        * {
            box-sizing: border-box;
            border-radius: 0 !important; 
            -webkit-tap-highlight-color: transparent;
            /* ç¦æ­¢é•¿æŒ‰é€‰ä¸­æ–‡æœ¬ï¼Œæå‡APPè´¨æ„Ÿ */
            user-select: none; 
            -webkit-touch-callout: none;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-paper);
            color: var(--ink);
            font-family: 'JetBrains Mono', monospace;
            overflow-x: hidden;
            /* ç§»åŠ¨ç«¯åº•éƒ¨å®‰å…¨è·ç¦» */
            padding-bottom: env(safe-area-inset-bottom);
            background-image: 
                linear-gradient(var(--bg-paper) 2px, transparent 2px),
                linear-gradient(90deg, var(--bg-paper) 2px, transparent 2px),
                linear-gradient(rgba(0,0,0,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.03) 1px, transparent 1px);
            background-size: 100px 100px, 100px 100px, 20px 20px, 20px 20px;
        }

        /* --- CRT è¦†ç›–å±‚ --- */
        .crt-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.05) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 9999;
        }

        /* --- å®¹å™¨ --- */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            min-height: 100vh;
            border-left: var(--border-thick) solid var(--ink);
            border-right: var(--border-thick) solid var(--ink);
            background: var(--bg-paper);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* --- Header --- */
        header {
            border-bottom: var(--border-thick) solid var(--ink);
            padding: 2rem 1rem;
            background: var(--ink);
            color: var(--bg-paper);
            position: relative;
        }

        h1 {
            font-family: 'Archivo Black', sans-serif;
            font-size: clamp(1.5rem, 5vw, 3.5rem); /* ç§»åŠ¨ç«¯å­—ä½“è‡ªé€‚åº” */
            margin: 0;
            line-height: 1;
            text-transform: uppercase;
            letter-spacing: -2px;
        }

        .meta-info {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.75rem;
            opacity: 0.8;
            border-top: 1px dashed var(--bg-paper);
            padding-top: 10px;
        }

        /* --- ä»ªè¡¨ç›˜ (Dashboard) --- */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            border-bottom: var(--border-thick) solid var(--ink);
            background: #fff;
        }

        .stat-box {
            padding: 15px;
            border-right: var(--border-thick) solid var(--ink);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-width: 0; /* é˜²æ­¢æº¢å‡º */
        }
        .stat-box:last-child { border-right: none; }

        .stat-label { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; margin-bottom: 5px; opacity: 0.6; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .stat-value { font-family: 'Archivo Black', sans-serif; font-size: 1.8rem; line-height: 1; }
        
        .stat-day .stat-value { color: var(--blue); }
        .stat-night .stat-value { color: #DDAA00; text-shadow: 1px 1px 0px #000; }
        .stat-off .stat-value { color: var(--red); }

        /* --- å·¥å…·æ åŒºåŸŸ (Tool Deck) --- */
        .tool-deck {
            padding: 20px;
            border-bottom: var(--border-thick) solid var(--ink);
            background: #f4f4f4;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: space-between;
        }

        /* PCç«¯æœˆä»½æ§åˆ¶ */
        .month-ctrl-desktop {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* ç§»åŠ¨ç«¯æœˆä»½æ§åˆ¶ (é»˜è®¤éšè—) */
        .month-ctrl-mobile {
            display: none;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--ink);
            color: var(--bg-paper);
            border-bottom: var(--border-thick) solid var(--ink);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .month-label {
            font-family: 'Archivo Black', sans-serif;
            font-size: 1.5rem;
            min-width: 140px;
            text-align: center;
        }

        /* å·¥å…·é€‰æ‹©å™¨ */
        .tool-selector {
            display: flex;
            gap: 10px;
            background: var(--ink);
            padding: 5px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.2);
            transition: opacity 0.3s;
        }
        
        .tool-selector.disabled {
            opacity: 0.4; pointer-events: none; filter: grayscale(1);
        }

        .tool-btn {
            border: 2px solid transparent;
            background: var(--bg-paper);
            color: var(--ink);
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            position: relative;
        }
        
        .tool-btn.active {
            border-color: #fff;
            transform: scale(0.95);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }
        /* é€‰ä¸­æ€é¢œè‰² */
        .tool-btn[data-tool="day"].active { background: var(--blue); color: #fff; }
        .tool-btn[data-tool="night"].active { background: var(--yellow); color: #000; }
        .tool-btn[data-tool="off"].active { background: var(--red); color: #fff; }
        .tool-btn[data-tool="erase"].active { background: #fff; text-decoration: line-through; }

        /* é€šç”¨æŒ‰é’® */
        .btn {
            background: transparent;
            border: 2px solid var(--ink);
            color: var(--ink);
            padding: 8px 16px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 0.8rem;
            cursor: pointer;
            box-shadow: 3px 3px 0px var(--ink);
            text-transform: uppercase;
        }
        .btn:active { transform: translate(2px, 2px); box-shadow: 0px 0px 0px var(--ink); }
        .btn-readonly.active { background: var(--orange); color: #fff; box-shadow: inset 0 0 0 2px #fff; }

        .btn-group { display: flex; gap: 10px; }

        /* --- æ—¥å†åŒºåŸŸ --- */
        .calendar-area {
            padding: 20px;
            background: var(--bg-paper);
            flex-grow: 1;
        }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border-bottom: var(--border-thick) solid var(--ink);
            background: var(--ink);
            gap: 2px;
            margin-bottom: 2px;
        }

        .weekday {
            background: var(--bg-paper);
            padding: 10px 0;
            text-align: center;
            font-weight: 800;
            font-size: 0.8rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: var(--ink);
            border-bottom: 2px solid var(--ink);
        }

        .day-cell {
            background: var(--bg-paper);
            aspect-ratio: 1 / 0.85; 
            position: relative;
            cursor: pointer;
            padding: 4px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: background 0.1s;
        }
        .day-cell.disabled { opacity: 0.5; pointer-events: none; }

        .date-num { font-family: 'Archivo Black'; font-size: 1.2rem; opacity: 0.3; pointer-events: none; }
        .shift-mark { font-size: 0.7rem; font-weight: 700; text-align: right; pointer-events: none; }

        /* çŠ¶æ€é¢œè‰² */
        .day-cell.status-day { background: var(--blue); color: #fff; }
        .day-cell.status-day .shift-mark { background: #fff; color: var(--blue); padding: 0 2px; }
        
        .day-cell.status-night { background: var(--yellow); color: #000; }
        .day-cell.status-night .shift-mark { background: #000; color: var(--yellow); padding: 0 2px; }

        .day-cell.status-off { 
            background: var(--red); color: #fff; 
            background-image: linear-gradient(45deg, #000 25%, transparent 25%, transparent 75%, #000 75%, #000), linear-gradient(45deg, #000 25%, transparent 25%, transparent 75%, #000 75%, #000);
            background-size: 10px 10px;
            background-position: 0 0, 5px 5px;
            opacity: 0.9;
        }
        .day-cell.status-off .shift-mark { background: #000; color: #fff; padding: 0 2px; }

        .day-cell.is-today { box-shadow: inset 0 0 0 4px var(--ink); z-index: 2; }
        .empty-cell { background: #dcdad0; pointer-events: none; }

        footer {
            padding: 20px;
            border-top: var(--border-thick) solid var(--ink);
            text-align: center;
            font-size: 0.7rem;
            opacity: 0.5;
            background: var(--bg-paper);
        }

        /* åªè¯»æç¤º */
        .readonly-indicator {
            position: fixed; top: 10px; right: 10px;
            background: var(--orange); color: #fff;
            padding: 8px 15px; font-weight: bold;
            transform: translateY(-100px); transition: transform 0.3s;
            z-index: 2000; box-shadow: 4px 4px 0 #000;
        }
        .readonly-indicator.show { transform: translateY(0); }

        /* =========================================
           ç§»åŠ¨ç«¯æ·±åº¦ä¼˜åŒ– (Max Width 768px)
           ========================================= */
        @media (max-width: 768px) {
            .container {
                border-left: none; border-right: none;
                /* ä¸ºåº•éƒ¨å›ºå®šå·¥å…·æ ç•™å‡ºç©ºé—´ */
                padding-bottom: 80px; 
            }

            header {
                padding: 1rem;
            }
            header h1 { font-size: 2rem; }
            .meta-info { display: none; } /* ç§»åŠ¨ç«¯èŠ‚çœç©ºé—´ï¼Œéšè—æ¬¡è¦ä¿¡æ¯ */

            /* 1. ä»ªè¡¨ç›˜ä¼˜åŒ–ï¼šæ¨ªå‘æ»šåŠ¨ */
            .dashboard {
                display: flex;
                overflow-x: auto;
                scroll-snap-type: x mandatory;
                border-bottom: var(--border-thick) solid var(--ink);
                /* éšè—æ»šåŠ¨æ¡ */
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .dashboard::-webkit-scrollbar { display: none; }

            .stat-box {
                min-width: 35%; /* éœ²å‡ºä¸€ç‚¹ä¸‹ä¸€ä¸ªï¼Œæç¤ºå¯æ»šåŠ¨ */
                scroll-snap-align: start;
                padding: 10px;
                border-right: 1px solid var(--ink);
            }
            .stat-value { font-size: 1.5rem; }

            /* 2. PCå·¥å…·æ æ‹†åˆ†ï¼šç§»åŠ¨ç«¯éšè—åŸå§‹å·¥å…·æ çš„å¸ƒå±€ */
            .tool-deck {
                padding: 10px;
                gap: 10px;
                background: #e0e0e0;
            }

            /* 3. ç§»åŠ¨ç«¯æœˆä»½å¯¼èˆªï¼šç½®é¡¶æ‚¬æµ® */
            .month-ctrl-desktop { display: none; }
            .month-ctrl-mobile { 
                display: flex; 
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            }
            .month-btn-mobile {
                background: var(--bg-paper); border: 2px solid #fff;
                width: 40px; height: 36px;
                display: flex; align-items: center; justify-content: center;
                font-weight: bold; font-size: 1.2rem;
            }

            /* 4. åº•éƒ¨å›ºå®šå·¥å…·æ  (Thumb Zone) */
            .mobile-tools-dock {
                position: fixed;
                bottom: 0; left: 0; right: 0;
                background: var(--ink);
                padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
                display: flex !important;
                justify-content: space-between;
                align-items: center;
                z-index: 1000;
                box-shadow: 0 -4px 10px rgba(0,0,0,0.3);
            }

            /* å°†PCçš„ tool-selector æ¬åˆ°åº•éƒ¨ */
            .tool-selector {
                background: transparent;
                box-shadow: none;
                padding: 0;
                gap: 5px;
                flex: 1;
                justify-content: center;
            }

            .tool-btn {
                flex: 1; /* å‡åˆ†å®½åº¦ */
                height: 50px; /* æ›´å¤§çš„ç‚¹å‡»åŒºåŸŸ */
                font-size: 1.4rem;
                max-width: 60px;
                border-radius: 4px !important; /* ç§»åŠ¨ç«¯ç¨å¾®åœ†æ¶¦ä¸€ç‚¹ç‚¹é˜²æ­¢çœ‹èµ·æ¥å¤ªå°–é”ï¼Œæˆ–è€…ä¿æŒ0 */
            }

            /* éšè— PC ä¸Šçš„å…¶ä»–æŒ‰é’®ï¼Œæ”¾å…¥â€œæ›´å¤šâ€æˆ–è€…ç®€åŒ– */
            .btn-group {
                display: none; /* ç§»åŠ¨ç«¯æš‚æ—¶éšè—å¤æ‚å¯¼å‡ºæŒ‰é’®ï¼Œä¸“æ³¨æ“ä½œ */
            }
            
            /* ç§»åŠ¨ç«¯æ—¥å†æ ¼å­æ¯”ä¾‹ */
            .day-cell { aspect-ratio: 1/1; }
            .date-num { font-size: 1rem; }
            .calendar-area { padding: 10px 5px; }
            
            /* ç§»åŠ¨ç«¯å¢åŠ ä¸€ä¸ªåªè¯»åˆ‡æ¢å’Œæ¸…é™¤çš„å°æŒ‰é’®åœ¨ Header */
            .mobile-header-actions {
                display: flex; gap: 10px; margin-top: 10px;
            }
            .mobile-action-btn {
                font-size: 0.7rem; padding: 4px 8px; border: 1px solid var(--bg-paper);
                color: var(--bg-paper); background: transparent;
            }
            .mobile-action-btn.active { background: var(--orange); border-color: var(--orange); }
        }

        /* PCç«¯éšè—ç§»åŠ¨ç«¯ä¸“ç”¨å…ƒç´  */
        @media (min-width: 769px) {
            .mobile-tools-dock { display: none; }
            .mobile-header-actions { display: none; }
        }

    </style>
</head>
<body>

    <div class="crt-overlay"></div>
    <div class="readonly-indicator" id="readonlyIndicator">ğŸ”’ READ ONLY</div>

    <div class="container">
        
        <header>
            <div style="display:flex; justify-content:space-between; align-items:start;">
                <div>
                    <div style="display:flex; align-items:baseline; gap:8px;">
                        <h1>Shift_Mgr</h1>
                        <span style="background:var(--bg-paper); color:var(--ink); padding:2px 4px; font-weight:bold; font-size:0.7rem;">V2.1</span>
                    </div>
                    <!-- ç§»åŠ¨ç«¯ Header é‡Œçš„ç®€æ˜“æ“ä½œåŒº -->
                    <div class="mobile-header-actions">
                        <button class="mobile-action-btn" id="mobBtnReadonly">LOCK</button>
                        <button class="mobile-action-btn" id="mobBtnClear">CLR</button>
                        <button class="mobile-action-btn" id="mobBtnSave">SAVE</button>
                    </div>
                </div>
                <div style="text-align:right;">
                    <div id="systemTime" style="font-size:0.7rem; opacity:0.7;">00:00:00</div>
                </div>
            </div>
            <div class="meta-info">
                <span>// INDUSTRIAL STANDARD</span>
                <span>RENDER: DOM_G5</span>
            </div>
        </header>

        <!-- ä»ªè¡¨ç›˜ï¼šç§»åŠ¨ç«¯æ¨ªå‘æ»šåŠ¨ï¼ŒPCç«¯Grid -->
        <div class="dashboard">
            <div class="stat-box stat-day">
                <span class="stat-label">Day (ç™½ç­)</span>
                <span class="stat-value" id="countDay">0</span>
            </div>
            <div class="stat-box stat-night">
                <span class="stat-label">Night (æ™šç­)</span>
                <span class="stat-value" id="countNight">0</span>
            </div>
            <div class="stat-box stat-off">
                <span class="stat-label">Off (ä¼‘æ¯)</span>
                <span class="stat-value" id="countOff">0</span>
            </div>
            <div class="stat-box" style="background: var(--ink); color: var(--bg-paper);">
                <span class="stat-label" style="color:#aaa;">Total</span>
                <span class="stat-value" id="countTotal">0</span>
            </div>
        </div>

        <!-- ç§»åŠ¨ç«¯ï¼šç½®é¡¶æœˆä»½å¯¼èˆª -->
        <div class="month-ctrl-mobile">
            <div class="month-btn-mobile" id="mobPrevMonth">&lt;</div>
            <div class="month-label" id="mobMonthLabel">OCT 23</div>
            <div class="month-btn-mobile" id="mobNextMonth">&gt;</div>
        </div>

        <!-- PCç«¯ï¼šå·¥å…·æ  (ç§»åŠ¨ç«¯ä¼šéšè—å¤§éƒ¨åˆ†å†…å®¹ï¼Œåªä¿ç•™ç»“æ„ç”¨äºé€»è¾‘) -->
        <div class="tool-deck">
            <div class="month-ctrl-desktop">
                <button class="btn" id="prevMonth">PREV</button>
                <div class="month-label" id="monthLabel">OCT 23</div>
                <button class="btn" id="nextMonth">NEXT</button>
            </div>

            <!-- PCç«¯æŒ‰é’®ç»„ -->
            <div class="btn-group">
                <button class="btn btn-readonly" id="btnReadonly">READONLY</button>
                <button class="btn" id="btnExportImg">IMG</button>
                <button class="btn" id="btnExportJson">DATA</button>
                <button class="btn" id="btnClear" style="border-color:var(--red); color:var(--red);">CLR</button>
                <input type="file" id="fileInput" hidden accept=".json">
            </div>
        </div>

        <div class="calendar-area">
            <div id="capture-target">
                <!-- æˆªå›¾ç”¨çš„éšè—æ ‡é¢˜ -->
                <div id="print-header" style="display:none; padding-bottom:10px; border-bottom:2px solid #000; margin-bottom:10px;">
                    <h2 style="margin:0; font-family:'Archivo Black'">SHIFT SCHEDULE</h2>
                    <div id="print-month-label"></div>
                </div>

                <div class="calendar-header">
                    <div class="weekday">SUN</div><div class="weekday">MON</div><div class="weekday">TUE</div>
                    <div class="weekday">WED</div><div class="weekday">THU</div><div class="weekday">FRI</div><div class="weekday">SAT</div>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <!-- JS ç”Ÿæˆ -->
                </div>
                
                <div id="print-footer" style="display:none; text-align:right; font-size:0.6rem; margin-top:5px;">Generated by Ind_Shift_Mgr</div>
            </div>
        </div>

        <footer class="desktop-only-footer">
            SYSTEM STATUS: ONLINE // TOUCH_OPTIMIZED
        </footer>
    </div>

    <!-- ç§»åŠ¨ç«¯ï¼šåº•éƒ¨å›ºå®šå·¥å…·æ  (Dock) -->
    <div class="mobile-tools-dock">
        <!-- è¿™é‡Œæ˜¯ç”»ç¬”å·¥å…·ï¼Œé€»è¾‘å…±ç”¨ -->
        <div class="tool-selector" id="toolSelector">
            <button class="tool-btn active" data-tool="cursor" title="Toggle">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"></path></svg>
            </button>
            <button class="tool-btn" data-tool="day" style="color: var(--blue);">D</button>
            <button class="tool-btn" data-tool="night" style="color: var(--yellow);">N</button>
            <button class="tool-btn" data-tool="off" style="color: var(--red);">O</button>
            <button class="tool-btn" data-tool="erase">X</button>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒé€»è¾‘ ---
        const CONFIG = {
            storageKey: 'ind_shift_v2_data',
            readonlyKey: 'ind_shift_v2_readonly'
        };

        const STATE = {
            currentDate: new Date(),
            data: JSON.parse(localStorage.getItem(CONFIG.storageKey)) || {},
            tool: 'cursor', 
            readonly: localStorage.getItem(CONFIG.readonlyKey) === 'true'
        };

        // DOMå¼•ç”¨
        const els = {
            grid: document.getElementById('calendarGrid'),
            monthLabel: document.getElementById('monthLabel'),
            mobMonthLabel: document.getElementById('mobMonthLabel'),
            tools: document.querySelectorAll('.tool-btn'),
            stats: {
                day: document.getElementById('countDay'),
                night: document.getElementById('countNight'),
                off: document.getElementById('countOff'),
                total: document.getElementById('countTotal')
            },
            btnReadonly: document.getElementById('btnReadonly'),
            mobBtnReadonly: document.getElementById('mobBtnReadonly'),
            readonlyIndicator: document.getElementById('readonlyIndicator'),
            toolSelector: document.getElementById('toolSelector')
        };

        function init() {
            renderCalendar();
            updateStats();
            startClock();
            if(STATE.readonly) toggleReadonly(true);

            // ç»‘å®šäº‹ä»¶
            setupNavigation();
            setupTools();
            setupActions();

            // è¿›åœºåŠ¨ç”»
            gsap.from(".container", {y: 30, opacity: 0, duration: 0.6, ease: "power3.out"});
            // åº•éƒ¨Dockè¿›åœº
            gsap.from(".mobile-tools-dock", {y: 100, duration: 0.8, delay: 0.2, ease: "back.out(1.2)"});
        }

        // --- å¯¼èˆªé€»è¾‘ ---
        function setupNavigation() {
            const change = (delta) => {
                // è§¦è§‰åé¦ˆ
                triggerHaptic(5);
                STATE.currentDate.setMonth(STATE.currentDate.getMonth() + delta);
                renderCalendar();
                updateStats();
            };

            document.getElementById('prevMonth').onclick = () => change(-1);
            document.getElementById('nextMonth').onclick = () => change(1);
            
            // ç§»åŠ¨ç«¯ä¸“ç”¨å¯¼èˆª
            document.getElementById('mobPrevMonth').onclick = () => change(-1);
            document.getElementById('mobNextMonth').onclick = () => change(1);
        }

        // --- å·¥å…·åˆ‡æ¢é€»è¾‘ ---
        function setupTools() {
            els.tools.forEach(btn => {
                // ä½¿ç”¨ touchstart æå‡ç§»åŠ¨ç«¯å“åº”é€Ÿåº¦
                btn.addEventListener('click', (e) => {
                    if (STATE.readonly) return;
                    triggerHaptic(10); // éœ‡åŠ¨

                    els.tools.forEach(b => b.classList.remove('active'));
                    // æ³¨æ„ï¼šå› ä¸ºæœ‰ä¸¤ç»„ä¸€æ ·çš„æŒ‰é’®ï¼ˆå¯èƒ½ï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡ dataset åŒæ­¥
                    const toolType = e.currentTarget.dataset.tool;
                    
                    document.querySelectorAll(`.tool-btn[data-tool="${toolType}"]`).forEach(b => {
                        b.classList.add('active');
                        // æŒ‰é’®æŒ‰ä¸‹åŠ¨ç”»
                        gsap.fromTo(b, {scale:0.8}, {scale:1, duration:0.2, ease:"back.out(2)"});
                    });

                    STATE.tool = toolType;
                });
            });
        }

        // --- åŠ¨ä½œæŒ‰é’®é€»è¾‘ ---
        function setupActions() {
            const handleReadonly = () => {
                toggleReadonly(!STATE.readonly);
                localStorage.setItem(CONFIG.readonlyKey, STATE.readonly);
                triggerHaptic(20);
            };

            els.btnReadonly.onclick = handleReadonly;
            els.mobBtnReadonly.onclick = handleReadonly;

            const handleClear = () => {
                if (STATE.readonly) return;
                if(confirm("Confirm: CLEAR ALL DATA?")) {
                    STATE.data = {};
                    saveData();
                    renderCalendar();
                    triggerHaptic([50, 50, 50]);
                }
            };
            document.getElementById('btnClear').onclick = handleClear;
            document.getElementById('mobBtnClear').onclick = handleClear;

            document.getElementById('btnExportJson').onclick = exportJson;
            document.getElementById('mobBtnSave').onclick = exportImage; // ç§»åŠ¨ç«¯ä¿å­˜ä¸»è¦æ˜¯å›¾ç‰‡
            document.getElementById('btnExportImg').onclick = exportImage;
            
            // æ–‡ä»¶å¯¼å…¥
            const fileInput = document.getElementById('fileInput');
            fileInput.onchange = importJson;
            document.getElementById('btnExportJson').oncontextmenu = (e) => {
                e.preventDefault();
                if(!STATE.readonly) fileInput.click();
            };
        }

        // --- æ ¸å¿ƒä¸šåŠ¡ ---
        function toggleReadonly(forceStatus) {
            STATE.readonly = forceStatus;
            const action = STATE.readonly ? 'add' : 'remove';
            
            els.btnReadonly.classList[action]('active');
            els.mobBtnReadonly.classList[action]('active');
            els.toolSelector.classList[STATE.readonly ? 'add' : 'remove']('disabled');
            els.readonlyIndicator.classList[STATE.readonly ? 'add' : 'remove']('show');
            
            els.btnReadonly.innerText = STATE.readonly ? 'UNLOCK' : 'READONLY';
            
            // åˆ·æ–°æ—¥å†ä»¥æ›´æ–°æ ¼å­çŠ¶æ€
            renderCalendar();
        }

        function saveData() {
            if(STATE.readonly) return;
            localStorage.setItem(CONFIG.storageKey, JSON.stringify(STATE.data));
            updateStats();
        }

        function handleCellInteract(dateStr) {
            if (STATE.readonly) {
                // åªè¯»æ¨¡å¼ä¸‹çš„åé¦ˆåŠ¨ç”»
                gsap.to(els.readonlyIndicator, {x: 5, yoyo: true, repeat: 3, duration: 0.05});
                triggerHaptic(50); // é•¿éœ‡åŠ¨è¡¨ç¤ºé”™è¯¯
                return;
            }

            const current = STATE.data[dateStr] || 'none';
            let next = 'none';

            if (STATE.tool === 'cursor') {
                const cycle = ['none', 'day', 'night', 'off'];
                next = cycle[(cycle.indexOf(current) + 1) % cycle.length];
            } else if (STATE.tool === 'erase') {
                next = 'none';
            } else {
                next = STATE.tool;
            }

            if (current !== next) {
                if (next === 'none') delete STATE.data[dateStr];
                else STATE.data[dateStr] = next;
                
                saveData();
                updateCell(document.querySelector(`.day-cell[data-date="${dateStr}"]`), next);
                triggerHaptic(15); // æ“ä½œæˆåŠŸçš„è½»éœ‡åŠ¨
            }
        }

        // --- æ¸²æŸ“ ---
        function renderCalendar() {
            els.grid.innerHTML = '';
            const year = STATE.currentDate.getFullYear();
            const month = STATE.currentDate.getMonth();
            const label = STATE.currentDate.toLocaleString('en-US', { month: 'short', year: '2-digit' }).toUpperCase();
            
            els.monthLabel.innerText = label;
            els.mobMonthLabel.innerText = label;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const todayStr = new Date().toISOString().slice(0,10);

            // å¡«å……ç©ºç™½
            for(let i=0; i<firstDay; i++) {
                els.grid.appendChild(createDiv('day-cell empty-cell'));
            }

            for(let day=1; day<=daysInMonth; day++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                const cell = createDiv('day-cell');
                cell.dataset.date = dateStr;
                
                if(dateStr === todayStr) cell.classList.add('is-today');
                if(STATE.readonly) cell.classList.add('disabled');

                cell.innerHTML = `<div class="date-num">${day}</div><div class="shift-mark"></div>`;
                
                updateCell(cell, STATE.data[dateStr] || 'none');

                // äº¤äº’ç»‘å®š (å…¼é¡¾ PC å’Œ Mobile)
                cell.onmousedown = () => handleCellInteract(dateStr);
                // ç§»åŠ¨ç«¯ Touch ä¼˜åŒ–ï¼šé˜²æ­¢å»¶è¿Ÿï¼Œä½†å…è®¸æ»šåŠ¨
                // ç®€å•çš„ click åœ¨ viewport è®¾ç½®äº† no-scalable åå…¶å®å»¶è¿Ÿå¾ˆå°
                // ä¿æŒ click å³å¯ï¼Œå¤æ‚ touch é€»è¾‘å®¹æ˜“å¯¼è‡´æ— æ³•æ»šåŠ¨

                els.grid.appendChild(cell);
            }
        }

        function createDiv(className) {
            const d = document.createElement('div');
            d.className = className;
            return d;
        }

        function updateCell(cell, type) {
            if(!cell) return;
            cell.classList.remove('status-day', 'status-night', 'status-off');
            const mark = cell.querySelector('.shift-mark');
            
            if (type !== 'none') {
                cell.classList.add(`status-${type}`);
                mark.innerText = type === 'day' ? 'DAY' : (type === 'night' ? 'NGT' : 'OFF');
                
                // åªæœ‰æ–°å¢çŠ¶æ€æ—¶æ‰æ’­æ”¾åŠ¨ç”»
                gsap.fromTo(mark, {opacity:0, x: -5}, {opacity:1, x:0, duration: 0.2});
            } else {
                mark.innerText = '';
            }
        }

        function updateStats() {
            const year = STATE.currentDate.getFullYear();
            const month = STATE.currentDate.getMonth() + 1;
            const prefix = `${year}-${String(month).padStart(2, '0')}`;
            
            let c = {day:0, night:0, off:0};
            Object.keys(STATE.data).forEach(k => {
                if(k.startsWith(prefix)) {
                    const t = STATE.data[k];
                    if(c[t] !== undefined) c[t]++;
                }
            });

            animateNum(els.stats.day, c.day);
            animateNum(els.stats.night, c.night);
            animateNum(els.stats.off, c.off);
            animateNum(els.stats.total, c.day + c.night);
        }

        function animateNum(el, val) {
            gsap.to(el, { innerText: val, duration: 0.5, snap: { innerText: 1 } });
        }

        // --- å·¥å…·å‡½æ•° ---
        function startClock() {
            setInterval(() => {
                document.getElementById('systemTime').innerText = new Date().toLocaleTimeString('en-GB');
            }, 1000);
        }

        function triggerHaptic(pattern) {
            if (navigator.vibrate) navigator.vibrate(pattern);
        }

        function exportJson() {
            const blob = new Blob([JSON.stringify(STATE.data, null, 2)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `shift_data_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }

        function importJson(e) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    STATE.data = JSON.parse(evt.target.result);
                    saveData();
                    renderCalendar();
                } catch(err) { alert("DATA CORRUPTED"); }
            };
            reader.readAsText(e.target.files[0]);
        }

        function exportImage() {
            const target = document.getElementById('capture-target');
            const pHeader = document.getElementById('print-header');
            const pFooter = document.getElementById('print-footer');
            const pLabel = document.getElementById('print-month-label');
            
            // å‡†å¤‡æˆªå›¾çŠ¶æ€
            pHeader.style.display = 'block';
            pFooter.style.display = 'block';
            pLabel.innerText = els.monthLabel.innerText;
            
            // å¦‚æœæ˜¯ç§»åŠ¨ç«¯ï¼Œå¼ºåˆ¶è®¾ç½®ä¸€ä¸ªå®½åº¦ä»¥ä¿è¯æˆªå›¾æ¸…æ™°åº¦
            const originalWidth = target.style.width;
            if (window.innerWidth < 768) target.style.width = "800px";

            // ä¸´æ—¶è§£é™¤åªè¯»æ ·å¼ï¼ˆä¸ºäº†æˆªå›¾å¥½çœ‹ï¼‰
            const wasReadonly = STATE.readonly;
            if(wasReadonly) document.querySelectorAll('.day-cell').forEach(c => c.classList.remove('disabled'));

            html2canvas(target, { scale: 2, backgroundColor: "#E6E4D8" }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Schedule_${els.monthLabel.innerText}.png`;
                link.href = canvas.toDataURL();
                link.click();
            }).finally(() => {
                // æ¢å¤
                pHeader.style.display = 'none';
                pFooter.style.display = 'none';
                target.style.width = originalWidth;
                if(wasReadonly) renderCalendar(); // é‡æ–°æ¸²æŸ“æ¢å¤ disabled çŠ¶æ€
            });
        }

        init();
    </script>
</body>
</html>
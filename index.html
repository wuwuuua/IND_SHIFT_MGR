<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#111111">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>IND_SHIFT_MGR // MOBILE</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --bg-paper: #E6E4D8;
            --bg-dark: #111111;
            --ink: #000000;
            --blue: #0033CC;
            --yellow: #FFCC00;
            --red: #FF3300;
            --orange: #FF6600;
            
            --border-thick: 2px; /* 移动端稍微减细一点 */
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        * {
            box-sizing: border-box;
            border-radius: 0 !important; 
            -webkit-tap-highlight-color: transparent;
            user-select: none; /* 防止长按选中文本 */
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-paper);
            color: var(--ink);
            font-family: 'JetBrains Mono', monospace;
            overflow: hidden; /* 禁止整体滚动，内部滚动 */
            height: 100dvh; /* 动态视口高度 */
            display: flex;
            flex-direction: column;
        }

        /* CRT 效果稍微减弱以提高移动端可读性 */
        .crt-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.02) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 9999;
        }

        /* --- 顶部区域 (压缩高度) --- */
        header {
            flex-shrink: 0;
            border-bottom: var(--border-thick) solid var(--ink);
            padding: 10px 15px;
            background: var(--ink);
            color: var(--bg-paper);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        h1 {
            font-family: 'Archivo Black', sans-serif;
            font-size: 1.2rem;
            margin: 0;
            letter-spacing: -1px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        /* 小图标按钮 */
        .icon-btn {
            background: transparent;
            border: 1px solid var(--bg-paper);
            color: var(--bg-paper);
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        .icon-btn svg { width: 16px; height: 16px; }

        /* --- 仪表盘 (紧凑版) --- */
        .dashboard {
            flex-shrink: 0;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            border-bottom: var(--border-thick) solid var(--ink);
            background: #fff;
            font-size: 0.8rem;
        }

        .stat-box {
            padding: 8px 4px;
            border-right: 1px solid var(--ink);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .stat-box:last-child { border-right: none; background: var(--ink); color: #fff; }

        .stat-label { font-size: 0.6rem; font-weight: 800; opacity: 0.6; margin-bottom: 2px; }
        .stat-value { font-family: 'Archivo Black', sans-serif; font-size: 1.2rem; line-height: 1; }
        
        .stat-day .stat-value { color: var(--blue); }
        .stat-night .stat-value { color: #DDAA00; }
        .stat-off .stat-value { color: var(--red); }

        /* --- 主滚动区域 --- */
        .main-scroll-area {
            flex: 1;
            overflow-y: auto;
            background: var(--bg-paper);
            position: relative;
            /* 增加底部内边距，防止内容被底部工具栏遮挡 */
            padding-bottom: calc(80px + var(--safe-bottom)); 
        }

        .month-display-strip {
            position: sticky;
            top: 0;
            background: var(--bg-paper);
            border-bottom: var(--border-thick) solid var(--ink);
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 5;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .month-nav-btn {
            background: none; border: none; font-family: 'Archivo Black'; font-size: 1.2rem;
            padding: 0 15px; cursor: pointer; color: var(--ink);
        }

        #monthLabel { font-family: 'Archivo Black'; font-size: 1.5rem; }

        /* --- 日历网格 --- */
        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--ink);
            gap: 1px;
            padding-top: 2px;
        }
        .weekday {
            background: var(--bg-paper);
            text-align: center;
            font-size: 0.7rem;
            font-weight: 800;
            padding: 5px 0;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--ink);
            border-bottom: 2px solid var(--ink);
            /* 移动端增加触摸反馈区域 */
            touch-action: pan-y; /* 允许垂直滚动，JS接管水平滑动 */
        }

        .day-cell {
            background: var(--bg-paper);
            aspect-ratio: 1 / 1.1; /* 更竖长，适合显示内容 */
            position: relative;
            padding: 4px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform 0.1s;
        }
        
        .day-cell:active { transform: scale(0.95); z-index: 10; background: #fff; }

        .date-num { font-family: 'Archivo Black'; font-size: 1rem; opacity: 0.4; }
        .shift-mark { font-size: 0.7rem; font-weight: 800; text-align: right; }

        /* 状态颜色 */
        .day-cell.status-day { background: var(--blue); color: #fff; }
        .day-cell.status-day .shift-mark { background: #fff; color: var(--blue); padding: 0 3px; }

        .day-cell.status-night { background: var(--yellow); color: #000; }
        .day-cell.status-night .shift-mark { background: #000; color: var(--yellow); padding: 0 3px;}

        .day-cell.status-off { 
            background: var(--red); color: #fff; 
            background-image: linear-gradient(45deg, #000 25%, transparent 25%, transparent 75%, #000 75%, #000), 
            linear-gradient(45deg, #000 25%, transparent 25%, transparent 75%, #000 75%, #000);
            background-size: 10px 10px;
            background-position: 0 0, 5px 5px;
            opacity: 0.9;
        }
        .day-cell.status-off .shift-mark { background: #000; color: #fff; padding: 0 3px; }

        .day-cell.is-today { box-shadow: inset 0 0 0 3px var(--ink); }

        /* --- 底部固定工具台 (Mobile Control Deck) --- */
        .mobile-control-deck {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: var(--ink);
            padding: 10px 10px calc(10px + var(--safe-bottom)) 10px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.3);
        }

        .control-btn {
            width: 50px; height: 50px;
            border: 2px solid transparent;
            background: #333;
            color: #fff;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            font-size: 0.7rem; font-weight: bold;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        .control-btn svg { width: 20px; height: 20px; margin-bottom: 2px; }

        /* 激活状态：向上浮起 */
        .control-btn.active {
            transform: translateY(-15px) scale(1.1);
            border: 2px solid #fff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            z-index: 101;
        }

        /* 具体颜色 */
        .btn-day.active { background: var(--blue); }
        .btn-night.active { background: var(--yellow); color: #000; }
        .btn-off.active { background: var(--red); }
        .btn-erase.active { background: #fff; color: #000; }
        
        .mode-indicator {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--ink);
            color: #fff;
            padding: 4px 10px;
            font-size: 0.7rem;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        .control-btn.active .mode-indicator { opacity: 1; }

        /* --- 只读遮罩 --- */
        .readonly-status-bar {
            position: fixed;
            bottom: calc(70px + var(--safe-bottom));
            left: 50%; transform: translateX(-50%);
            background: var(--orange);
            color: #fff;
            padding: 5px 15px;
            font-family: 'Archivo Black';
            font-size: 0.8rem;
            pointer-events: none;
            display: none;
            z-index: 99;
            box-shadow: 4px 4px 0 #000;
        }

        /* 隐藏的文件输入 */
        #fileInput { display: none; }

        /* --- 打印容器 (截图用) --- */
        #capture-target { padding: 10px; background: var(--bg-paper); }

    </style>
</head>
<body>

    <div class="crt-overlay"></div>
    <div class="readonly-status-bar" id="readonlyBar">LOCK MODE</div>

    <!-- 1. Compact Header -->
    <header>
        <div>
            <h1>SHIFT_V2</h1>
            <span style="font-size:0.6rem; opacity:0.7">MOBILE_BUILD</span>
        </div>
        <div class="header-actions">
            <!-- 功能菜单: 导出/导入/重置 -->
            <button class="icon-btn" id="btnMenu" title="Menu">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
            </button>
            <button class="icon-btn" id="btnReadonly" title="Lock">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
            </button>
        </div>
    </header>

    <!-- 2. Compact Stats Grid -->
    <div class="dashboard">
        <div class="stat-box stat-day">
            <span class="stat-label">DAY</span>
            <span class="stat-value" id="countDay">0</span>
        </div>
        <div class="stat-box stat-night">
            <span class="stat-label">NGT</span>
            <span class="stat-value" id="countNight">0</span>
        </div>
        <div class="stat-box stat-off">
            <span class="stat-label">OFF</span>
            <span class="stat-value" id="countOff">0</span>
        </div>
        <div class="stat-box">
            <span class="stat-label">TOT</span>
            <span class="stat-value" id="countTotal">0</span>
        </div>
    </div>

    <!-- 3. Scrollable Calendar Area -->
    <div class="main-scroll-area" id="scrollArea">
        
        <div class="month-display-strip">
            <button class="month-nav-btn" id="prevMonth">&lt;</button>
            <div id="monthLabel">OCT 23</div>
            <button class="month-nav-btn" id="nextMonth">&gt;</button>
        </div>

        <div id="capture-target">
            <div class="calendar-header">
                <div class="weekday">SUN</div><div class="weekday">MON</div><div class="weekday">TUE</div>
                <div class="weekday">WED</div><div class="weekday">THU</div><div class="weekday">FRI</div><div class="weekday">SAT</div>
            </div>
            <div class="calendar-grid" id="calendarGrid">
                <!-- Grid items generated by JS -->
            </div>
        </div>
    </div>

    <!-- 4. Sticky Bottom Control Deck -->
    <div class="mobile-control-deck">
        
        <div class="control-btn active" data-tool="cursor">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"></path></svg>
            <span class="mode-indicator">TAP CYCLE</span>
        </div>

        <div class="control-btn btn-day" data-tool="day">
            <div style="font-family:'Archivo Black'; font-size:1.2rem;">D</div>
            <span class="mode-indicator">PAINT DAY</span>
        </div>

        <div class="control-btn btn-night" data-tool="night">
            <div style="font-family:'Archivo Black'; font-size:1.2rem;">N</div>
            <span class="mode-indicator">PAINT NIGHT</span>
        </div>

        <div class="control-btn btn-off" data-tool="off">
            <div style="font-family:'Archivo Black'; font-size:1.2rem;">O</div>
            <span class="mode-indicator">PAINT OFF</span>
        </div>

        <div class="control-btn btn-erase" data-tool="erase">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"></path></svg>
            <span class="mode-indicator">ERASER</span>
        </div>

    </div>

    <input type="file" id="fileInput" accept=".json">

    <script>
        // --- 触觉反馈封装 ---
        const vibrate = (pattern = 10) => {
            if (navigator.vibrate) navigator.vibrate(pattern);
        };

        // --- 配置与状态 ---
        const CONFIG = {
            storageKey: 'ind_shift_v2_data',
            readonlyKey: 'ind_shift_v2_readonly'
        };

        const STATE = {
            currentDate: new Date(),
            data: JSON.parse(localStorage.getItem(CONFIG.storageKey)) || {},
            tool: 'cursor', 
            readonly: localStorage.getItem(CONFIG.readonlyKey) === 'true'
        };

        // --- DOM ---
        const els = {
            grid: document.getElementById('calendarGrid'),
            monthLabel: document.getElementById('monthLabel'),
            scrollArea: document.getElementById('scrollArea'),
            controls: document.querySelectorAll('.control-btn'),
            stats: {
                day: document.getElementById('countDay'),
                night: document.getElementById('countNight'),
                off: document.getElementById('countOff'),
                total: document.getElementById('countTotal')
            },
            btnReadonly: document.getElementById('btnReadonly'),
            btnMenu: document.getElementById('btnMenu'),
            readonlyBar: document.getElementById('readonlyBar'),
            fileInput: document.getElementById('fileInput')
        };

        function init() {
            renderCalendar();
            updateStats();
            
            if (STATE.readonly) toggleReadonly(true);

            // 月份导航
            document.getElementById('prevMonth').addEventListener('click', () => { vibrate(15); changeMonth(-1); });
            document.getElementById('nextMonth').addEventListener('click', () => { vibrate(15); changeMonth(1); });

            // 底部工具栏逻辑
            els.controls.forEach(btn => {
                btn.addEventListener('touchstart', (e) => { // 移动端优先使用 touchstart 减少延迟
                    if (STATE.readonly) return;
                    e.preventDefault(); 
                    vibrate(20);
                    
                    els.controls.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    STATE.tool = btn.dataset.tool;
                });
            });

            // 菜单按钮 (简化的 Action Sheet)
            els.btnMenu.addEventListener('click', showActionMenu);

            // 只读切换
            els.btnReadonly.addEventListener('click', () => {
                vibrate([10, 30, 10]);
                toggleReadonly(!STATE.readonly);
                localStorage.setItem(CONFIG.readonlyKey, STATE.readonly);
            });

            // 手势监听 (左右滑动切换月份)
            initSwipeGestures();

            // 文件导入
            els.fileInput.addEventListener('change', importJson);

            // 进场动画
            gsap.from(".mobile-control-deck", {y: 100, duration: 0.8, ease: "power4.out"});
        }

        // --- 手势识别 ---
        function initSwipeGestures() {
            let touchStartX = 0;
            let touchStartY = 0;
            
            const area = els.scrollArea; // 仅在日历区域监听

            area.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, {passive: true});

            area.addEventListener('touchend', e => {
                const touchEndX = e.changedTouches[0].screenX;
                const touchEndY = e.changedTouches[0].screenY;
                
                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;

                // 只有当水平滑动明显大于垂直滑动时才触发，防止影响上下滚动
                if (Math.abs(deltaX) > 50 && Math.abs(deltaX) > Math.abs(deltaY) * 1.5) {
                    if (deltaX > 0) changeMonth(-1); // 右滑 -> 上个月
                    else changeMonth(1); // 左滑 -> 下个月
                    vibrate(15);
                }
            }, {passive: true});
        }

        function showActionMenu() {
            vibrate(10);
            // 这里使用简单的原生 confirm/alert 模拟菜单，或者创建一个浮层
            // 为了代码简洁，这里做一个简单的交互逻辑
            const action = prompt("MENU COMMANDS:\n1. Save Image (截图)\n2. Export Data (导出数据)\n3. Import Data (导入数据)\n4. Clear Data (清空)", "1");
            
            if (action === "1") exportImage();
            else if (action === "2") exportJson();
            else if (action === "3") { 
                if(!STATE.readonly) els.fileInput.click(); 
                else alert("Unlock first.");
            }
            else if (action === "4") clearData();
        }

        function toggleReadonly(force) {
            STATE.readonly = force;
            if (STATE.readonly) {
                els.readonlyBar.style.display = 'block';
                els.btnReadonly.querySelector('svg').style.stroke = 'var(--orange)';
                document.querySelector('.mobile-control-deck').style.filter = 'grayscale(1) opacity(0.5)';
                document.querySelector('.mobile-control-deck').style.pointerEvents = 'none';
            } else {
                els.readonlyBar.style.display = 'none';
                els.btnReadonly.querySelector('svg').style.stroke = 'currentColor';
                document.querySelector('.mobile-control-deck').style.filter = 'none';
                document.querySelector('.mobile-control-deck').style.pointerEvents = 'auto';
            }
            renderCalendar(); // 重新渲染以禁用/启用格子交互
        }

        function changeMonth(delta) {
            // 简单的切换动画
            gsap.to(els.grid, {
                x: delta > 0 ? -20 : 20, 
                opacity: 0, 
                duration: 0.1, 
                onComplete: () => {
                    STATE.currentDate.setMonth(STATE.currentDate.getMonth() + delta);
                    renderCalendar();
                    updateStats();
                    gsap.fromTo(els.grid, {x: delta > 0 ? 20 : -20, opacity: 0}, {x: 0, opacity: 1, duration: 0.2});
                }
            });
        }

        function renderCalendar() {
            els.grid.innerHTML = '';
            const year = STATE.currentDate.getFullYear();
            const month = STATE.currentDate.getMonth();
            
            els.monthLabel.innerText = STATE.currentDate.toLocaleString('en-US', { month: 'short', year: '2-digit' }).toUpperCase();

            const firstDay = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDay = firstDay.getDay();

            for (let i = 0; i < startDay; i++) {
                const div = document.createElement('div');
                div.className = 'day-cell empty-cell';
                div.style.background = '#dcdad0';
                els.grid.appendChild(div);
            }

            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const cell = document.createElement('div');
                cell.className = 'day-cell';
                if (isCurrentMonth && day === today.getDate()) cell.classList.add('is-today');

                const num = document.createElement('div');
                num.className = 'date-num';
                num.innerText = day;
                
                const mark = document.createElement('div');
                mark.className = 'shift-mark';
                
                cell.appendChild(num);
                cell.appendChild(mark);

                updateCellVisual(cell, STATE.data[dateStr] || 'none');

                // 交互
                if (!STATE.readonly) {
                    // 支持快速点击
                    cell.onclick = () => {
                        vibrate(5);
                        handleInteraction(dateStr, cell);
                    };
                }

                els.grid.appendChild(cell);
            }
        }

        function handleInteraction(dateStr, cell) {
            const current = STATE.data[dateStr] || 'none';
            let next = 'none';

            if (STATE.tool === 'cursor') {
                const cycle = ['none', 'day', 'night', 'off'];
                next = cycle[(cycle.indexOf(current) + 1) % cycle.length];
            } else if (STATE.tool === 'erase') {
                next = 'none';
            } else {
                next = STATE.tool;
            }

            if (current !== next) {
                if (next === 'none') delete STATE.data[dateStr];
                else STATE.data[dateStr] = next;
                
                updateCellVisual(cell, next);
                saveData();
                
                // 视觉反馈动画
                gsap.fromTo(cell, {scale: 0.9}, {scale: 1, duration: 0.3, ease: "back.out(2)"});
            }
        }

        function updateCellVisual(cell, type) {
            cell.className = 'day-cell' + (cell.classList.contains('is-today') ? ' is-today' : '');
            const mark = cell.querySelector('.shift-mark');
            
            if (type !== 'none') {
                cell.classList.add(`status-${type}`);
                mark.innerText = type === 'day' ? 'DAY' : (type === 'night' ? 'NGT' : 'OFF');
            } else {
                mark.innerText = '';
            }
        }

        function updateStats() {
            const year = STATE.currentDate.getFullYear();
            const month = STATE.currentDate.getMonth() + 1;
            const prefix = `${year}-${String(month).padStart(2, '0')}`;

            let counts = { day: 0, night: 0, off: 0 };
            Object.keys(STATE.data).forEach(date => {
                if (date.startsWith(prefix)) {
                    const type = STATE.data[date];
                    if (counts[type] !== undefined) counts[type]++;
                }
            });

            els.stats.day.innerText = counts.day;
            els.stats.night.innerText = counts.night;
            els.stats.off.innerText = counts.off;
            els.stats.total.innerText = counts.day + counts.night;
        }

        function saveData() {
            localStorage.setItem(CONFIG.storageKey, JSON.stringify(STATE.data));
            updateStats();
        }

        // --- 功能 ---
        function exportImage() {
            if (STATE.readonly) { alert("Please Unlock First"); return; }
            const target = document.getElementById('capture-target');
            
            // 截图前优化样式
            const originalWidth = target.style.width;
            target.style.width = "800px"; // 强制宽度保证清晰度
            target.style.position = "absolute"; // 移出视口防止闪烁
            target.style.top = "-9999px";
            document.body.appendChild(target);

            html2canvas(target, { scale: 2, backgroundColor: "#E6E4D8" }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Shift_${els.monthLabel.innerText}.png`;
                link.href = canvas.toDataURL();
                link.click();
            }).finally(() => {
                // 还原
                target.style.width = "";
                target.style.position = "";
                target.style.top = "";
                els.scrollArea.appendChild(target);
            });
        }

        function exportJson() {
            const blob = new Blob([JSON.stringify(STATE.data, null, 2)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'shift_data.json';
            a.click();
        }

        function importJson(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                if(confirm("Overwrite current data?")) {
                    try {
                        STATE.data = JSON.parse(evt.target.result);
                        saveData();
                        renderCalendar();
                    } catch(e) { alert("Error Data"); }
                }
            };
            reader.readAsText(file);
        }

        function clearData() {
            if (STATE.readonly) return;
            if(confirm("CLEAR ALL DATA?")) {
                STATE.data = {};
                saveData();
                renderCalendar();
            }
        }

        init();
    </script>
</body>
</html>